{% extends 'base.html' %}

{% block main %}
<div class="map-container">
    <div class="title">
        <h3>Waste Collection Map</h3>
        <p>Interactive map showing reported waste locations and collection routes</p>
    </div>
    <div class="content">
        <div id="mapid" class="map"></div>
        <div class="legend">
            <h3>Reported Location</h3>
            <p class="loc">active locations</p>
            <ul>
                {% for location in data %}
                <li class="card">
                    <span>
                        <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                            <defs>
                                <style>
                                    .cls-1 {
                                        fill: #101820;
                                    }
                                </style>
                            </defs>
                            <title></title>
                            <g data-name="Layer 57" id="Layer_57">
                                <path class="cls-1"
                                    d="M16,31A15,15,0,1,1,31,16,15,15,0,0,1,16,31ZM16,3A13,13,0,1,0,29,16,13,13,0,0,0,16,3Z"
                                    style="fill: rgb(244, 147, 149); opacity: 1; stroke: rgb(0, 0, 0); stroke-width: 0px;">
                                </path>
                                <path class="cls-1" d="M16,24a2,2,0,1,1,2-2A2,2,0,0,1,16,24Zm0-2Z"
                                    style="fill: rgb(244, 147, 149); opacity: 1; stroke: rgb(0, 0, 0); stroke-width: 0px;">
                                </path>
                                <path class="cls-1" d="M16,18a1,1,0,0,1-1-1V8a1,1,0,0,1,2,0v9A1,1,0,0,1,16,18Z"
                                    style="fill: rgb(244, 147, 149); opacity: 1; stroke: rgb(0, 0, 0); stroke-width: 0px;">
                                </path>
                            </g>
                        </svg>
                        <div class="pill {{location[2]}}">

                            {{location[2]}}
                        </div>
                    </span>
                    <h6 class="title">{{location[0]}}</h6>
                    <p class="loc">{{location[1]}}</p>
                    <form action="/collected/{{location[3]}}" method="put">
                        <input type="button" value="id" hidden>
                        <button type="submit" {% if location[2]=='Collected' %} return disabled="disabled"
                            
                        {% endif %}>
                            <svg data-name="Слой 1" id="Слой_1" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg"
                                width="16" height="16">
                                <title></title>
                                <path
                                    d="M64,128a64,64,0,1,1,64-64A64.07,64.07,0,0,1,64,128ZM64,4a60,60,0,1,0,60,60A60.07,60.07,0,0,0,64,4Z"
                                    style="fill: rgb(255, 255, 255); opacity: 1; stroke: rgb(255, 255, 255); stroke-width: 0px;">
                                </path>
                                <path
                                    d="M66.51,83a2,2,0,0,1-1.31-.49L63.41,81A2,2,0,1,1,66,78l.26.22L93.47,45.68a2,2,0,1,1,3.06,2.56L68.05,82.32a2,2,0,0,1-1.38.71Z"
                                    style="fill: rgb(255, 255, 255); opacity: 1; stroke: rgb(255, 255, 255); stroke-width: 0px;">
                                </path>
                                <path
                                    d="M52.94,83a2,2,0,0,1-1.42-.59L31.59,62.52a2,2,0,0,1,2.82-2.83L52.8,78.08l27.09-32.4A2,2,0,0,1,83,48.24L54.47,82.32A2,2,0,0,1,53,83Z"
                                    style="fill: rgb(255, 255, 255); opacity: 1; stroke: rgb(255, 255, 255); stroke-width: 0px;">
                                </path>
                            </svg>
                            Mark as Collected
                        </button>
                    </form>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let landmarks = []
    async function getMarkers() {
        const resp = await fetch('/map/markers')
        const data = await resp.text()
        let markers = JSON.parse(data)
        
        markers.forEach(locus => {
            landmarks.push({lat:locus[0],lng:locus[1]})
            const marker = L.marker([locus[0], locus[1]], {
                icon: createCustomIcon(iconColors[3])
            }).addTo(mymap);
        });
    }

    getMarkers()
    
    // Initialize the map and set its view to a geographical center and a zoom level
    let mymap = L.map('mapid').setView([30, 0], 2);

    // Add a tile layer to the map. This is what provides the actual map imagery.
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(mymap);
    mymap.invalidateSize();

    // Define custom icons for markers
    const iconColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6'];

    // Create custom icon
    function createCustomIcon(color) {
        return L.divIcon({
            className: 'custom-icon',
            html: `<div style="background-color: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>`,
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });
    }
    
</script>
{% endblock %}